<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>OT Pro | Sigma Alimentos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0077b6">
  <link rel="manifest" href="manifest.json">

  <!-- Estilos -->
  <link rel="stylesheet" href="style.css?v=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">



  <!-- Firebase & libs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- 1) Carga PDF-Lib (ponlo en tu index.txt) -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.11.0/libs/pptxgen.min.js"></script>


  <!-- QR library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
</head>
<body>
<!-- BOT√ìN HAMBURGUESA: Mostrar/ocultar men√∫ en m√≥vil -->
  <button id="menuToggle" class="menu-toggle">‚ò∞</button>
<!-- Men√∫ lateral con logo -->
<nav class="sidebar">
  <img src="logo-sigma.png" alt="Sigma Alimentos" class="logo-sigma">
  <h2>OT Pro</h2>
  <span id="userName" class="usuario-nombre"></span>
  <button id="navNuevaOT">‚ûï Nueva OT</button>
  <button id="navMultidisciplinaria">üîÄ Multidisciplinaria</button>
    <button id="navHistorial">üìÅ Historial</button>
    <button id="navDashboard">üìä Graficos OT</button>
  <button id="navCalendario">üìÖ Calendario</button>
  <button id="navConfiguracion">‚öôÔ∏è Configuraci√≥n</button>
  <button id="loginBtn"><i class="fas fa-user"></i> Iniciar sesi√≥n</button>
</nav>

<div class="main-content">

<section id="seccionFormulario">
  <h1 class="titulo-centro">üìã Registrar Orden de Trabajo</h1>
  <form id="otForm" class="ot-form">

    <!-- üóìÔ∏è DATOS GENERALES --> 
    <div class="form-section">
      <h2>üóìÔ∏è Datos generales</h2> 
      <div class="ot-grid">
        <div class="ot-group"><label>Fecha</label><input name="fecha" id="otFecha" type="date" required></div>
        <div class="ot-group">
  <label>√Årea</label>
  <select name="area" id="selectArea" required>
  <option value="">Seleccione √Årea</option>
</select>
</div>
<div class="ot-group">
  <label>Equipo</label>
  <select name="equipo" id="selectEquipo" required>
    <option value="">Seleccione Equipo</option>
  </select>
</div>

      </div>
    </div>

    <!-- üïí TIEMPOS -->
    <div class="form-section">
      <h2>üïí Tiempos</h2>
      <div class="ot-grid">
        <div class="ot-group"><label>Hora falla</label><input name="horaFalla" required type="time" /></div>
        <div class="ot-group"><label>Hora notificaci√≥n</label><input name="horaNotificacion" required type="time" /></div>
        <div class="ot-group admin-only"><label>Hora inicio</label><input name="horaInicioReparacion" type="time" /></div>
        <div class="ot-group admin-only"><label>Hora fin</label><input name="horaFinReparacion" type="time" /></div>
        <div class="ot-group admin-only"><label>Tiempo total (min)</label><input name="tiempototal" id="tiempototal" readonly /></div>
      </div>
    </div>

    <!-- üîß INFORMACI√ìN T√âCNICA -->
    <div class="form-section">
      <h2>üîß Informaci√≥n t√©cnica</h2>
      <div class="ot-grid">
        <div class="ot-group ot-wide"><label>Descripci√≥n de la falla</label><textarea name="descripcionFallaTecnica"></textarea></div>
        <div class="ot-group ot-wide admin-only"><label>Soluci√≥n implementada</label><textarea name="solucionTecnica"></textarea></div>
      </div>
    </div>

 <!-- ‚öôÔ∏è CONFIGURACI√ìN OT -->
<div class="form-section admin-only">
  <h2>‚öôÔ∏è Configuraci√≥n OT</h2>
  <div class="ot-grid">
    <div class="ot-group">
      <label>Tipo OT</label>
      <select name="tipo">
        <option value="Correctiva">Correctiva</option>
        <option value="Preventiva">Preventiva</option>
        <option value="Predictiva">Predictiva</option>
      </select>
    </div>
    <div class="ot-group">
      <label>Prioridad</label>
      <select name="prioridad">
        <option value="Alta">Alta</option>
        <option value="Media">Media</option>
        <option value="Baja">Baja</option>
      </select>
    </div>
    <div class="ot-group">
      <label>Categor√≠a</label>
      <select name="categoriaFalla" id="categoriaFalla">
        <option value="">Seleccione una categor√≠a</option>
        <option value="DESGASTE NATURAL">DESGASTE NATURAL</option>
        <option value="DESGASTE FORZADO">DESGASTE FORZADO</option>
        <option value="ERROR HUMANO">ERROR HUMANO</option>
        <option value="MALA OPERACI√ìN">MALA OPERACI√ìN</option>
        <option value="DISE√ëO EQUIPO">DISE√ëO EQUIPO</option>
      </select>
    </div>
    <div class="ot-group">
      <label>Estado</label>
      <select name="estado">
        <option value="Abierta">Abierta</option>
        <option value="En progreso">En progreso</option>
        <option value="Cerrada">Cerrada</option>
      </select>
    </div>
    <div class="ot-group">
      <label>N√∫mero de orden SAP</label>
      <input
        name="numeroSAP"
        type="text"
        placeholder="Ej: 4500XXXX"
      />
    </div>
  </div>
</div>

   <!-- üßº SANITIZACI√ìN -->
<div class="form-section admin-only">
  <h2>üßº Limpieza y sanitizaci√≥n</h2>
  <!-- TODO el contenido en un √∫nico grid -->
  <div id="bloqueSanitizacion" class="hidden ot-grid">
    <div class="ot-group">
      <label for="zonaContacto">¬øReparaci√≥n en zona de contacto?</label>
      <select name="zonaContacto" id="zonaContacto">
        <option value="No">No</option>
        <option value="S√≠">S√≠</option>
      </select>
    </div>
    <div class="ot-group">
       <label>Actividad de limpieza</label>
  <select name="actividadLimpieza">
    <option value="S√≠">S√≠</option>
    <option value="No">No</option>
  </select>
    </div>
    <div class="ot-group">
      <label for="personaLimpieza">Persona que limpia</label>
      <input name="personaLimpieza" id="personaLimpieza" type="text">
    </div>
    <div class="ot-group">
  <label for="inspeccionVisual">Inspecci√≥n de Calidad</label>
  <select name="inspeccionVisual" id="inspeccionVisual" >
    <option value="">Seleccione Inspector</option>
  </select>
</div>
    <div class="ot-group">
      <label for="horaInicioLimpieza">Hora inicio limpieza</label>
      <input name="horaInicioLimpieza" id="horaInicioLimpieza" type="time">
    </div>
    <div class="ot-group">
      <label for="horaFinLimpieza">Hora fin limpieza</label>
      <input name="horaFinLimpieza" id="horaFinLimpieza" type="time">
    </div>
  </div>
</div>


    <!-- üß™ VALIDACI√ìN DE HIGIENE -->
    <div class="form-section admin-only">
      <h2>üß™ Validaci√≥n</h2>
      <div class="ot-grid">
        <div class="ot-group">
          <label>Tipo de limpieza</label>
          <select name="tipoLimpieza">
            <option value="LYS">LVS</option>
            <option value="D">D</option>
            <option value="N/A">N/A</option>
          </select>
        </div>
        <div class="ot-group">
          <label>Resultado ATP</label>
          <input type="number" name="resultadoATP" step="1" placeholder="ATP" />
        </div>
      </div>
    </div>
   
   <!-- üìÅ Informaci√≥n adicional -->
<div class="form-section admin-only">
  <h2>üìÅ Informaci√≥n adicional</h2>
  <div class="ot-grid info-grid">
    <div class="ot-group">
      <label>El √°rea/equipos se entregan libres</label>
      <select name="libre">
        <option value="S√≠">S√≠</option>
        <option value="No">No</option>
      </select>
    </div>
    <div class="ot-group">
      <label>Zonas de contacto</label>
      <select name="zonas">
        <option value="S√≠">S√≠</option>
        <option value="No">No</option>
      </select>
    </div>
  </div>  <!-- cierra .ot-grid info-grid -->
</div>    <!-- cierra .form-section -->

<!-- üñºÔ∏è Evidencias -->
<div class="form-section">
  <h2>üñºÔ∏è Evidencias</h2>
  <div class="ot-grid evidencias-grid">
    <div class="ot-group">
      <label for="evidenciaAntes">üïí Evidencia Antes (m√°x 2)</label>
      <input
        type="file"
        id="evidenciaAntes"
        name="evidenciaAntes"
        accept="image/*"
        multiple
      />
      <div id="previewAntes" class="image-preview"></div>
    </div>
    <div class="ot-group admin-only">
      <label for="evidenciaDespues">‚úÖ Evidencia Despu√©s (m√°x 2)</label>
      <input
        type="file"
        id="evidenciaDespues"
        name="evidenciaDespues"
        accept="image/*"
        multiple
      />
      <div id="previewDespues" class="image-preview"></div>
    </div>
  </div>  <!-- cierra .ot-grid evidencias-grid -->
</div>    <!-- cierra .form-section -->

 <!-- ‚úçÔ∏è FIRMAS -->
    <div class="form-section">
      <h2>‚úçÔ∏è Firmas</h2>
      <div class="ot-grid">
        <div class="ot-group admin-only">
          <label>T√©cnico</label>
          <select name="firmaTecnico" id="selectFirmaTecnico">
            <option value="">Seleccione T√©cnico</option>
          </select>
        </div>
<div class="ot-group">
  <label>Operador</label>
  <select name="firmaOperador" id="selectFirmaOperador" >
    <option value="">Seleccione Operador</option>
  </select>
</div>
<div class="ot-group">
  <label>Supervisor</label>
  <select name="firmaSupervisor" id="selectFirmaSupervisor" required>
    <option value="">Seleccione Supervisor</option>
  </select>
</div>

      </div>
    </div>
    <button type="submit" class="ot-submit">üíæ Guardar OT</button>

    
  </form>
</section>

<!-- Secci√≥n Historial -->
<section id="seccionHistorial" style="display: none;">
  <h2>Historial OT</h2>

  <div class="filtros-ot">
    <select id="filtroEstado">
      <option value="">Todos los estados</option>
      <option value="Abierta">Abierta</option>
      <option value="En Proceso">En Proceso</option>
      <option value="Cerrada">Cerrada</option>
    </select>

    <select id="filtroArea">
      <option value="">Todas las √°reas</option>
      <!-- √Åreas din√°micas -->
    </select>

    <input id="filtroFecha" type="month" placeholder="Mes">
  </div>

  <div class="tabla-wrapper">
    <table id="otTable">
      <thead>
        <tr>
          <th># OT</th>
          <th>Fecha</th>
          <th>√Årea</th>
          <th>Equipo</th>
          <th>Estado</th>
          <th>Prioridad</th>
          <th>Tipo</th>
          <th>Tiempo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="otTableBody">
        <!-- Filas din√°micas -->
      </tbody>
    </table>
  </div>
</section>

<!-- ‚Äî‚Äî‚Äî Secci√≥n Multidisciplinaria ‚Äî‚Äî‚Äî -->
<section id="seccionMultidisciplinaria" style="display: none;">
  <h2>Multidisciplinaria</h2>

  <div class="filtros-ot">
    <select id="filtroEstadoMD">
      <option value="">Todos los estados</option>
      <option value="Abierta">Abierta</option>
      <option value="En Proceso">En Proceso</option>
      <option value="Cerrada">Cerrada</option>
    </select>

    <select id="filtroAreaMD">
      <option value="">Todas las √°reas</option>
      <!-- Opciones din√°micas -->
    </select>

    <input id="filtroFechaMD" type="month" placeholder="Mes">

    <button id="btnNuevoMD" class="ot-submit">‚ûï Nueva Multidisciplinaria</button>
    </button>

  </div>

  <div class="tabla-wrapper">
  <table id="mdTable">
  <thead>
    <tr>
      <th>Descripci√≥n</th>
      <th>√Årea</th>
      <th>Estado</th>
      <th>Prioridad</th>     <!-- ‚Üê nueva posici√≥n -->
      <th>Fecha Inicio</th>
      <th>Fecha Final</th>
      <th>Corrigi√≥</th>
      <th>Antes</th>
      <th>Despu√©s</th>
      <th>Acciones</th>
    </tr>
  </thead>


      <tbody id="mdTableBody">
        <!-- Filas din√°micas -->
      </tbody>
    </table>
  </div>
</section>
<!-- ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî -->

<!-- Tablero Kanban -->
<section id="seccionKanban">
  <h2>Tablero Kanban</h2>
  <div class="kanban-columns">
    <div class="kanban-column" id="colAbierta"><h3>Abierta</h3><div class="kanban-list"></div></div>
    <div class="kanban-column" id="colProgreso"><h3>En progreso</h3><div class="kanban-list"></div></div>
    <div class="kanban-column" id="colCerrada"><h3>Cerrada</h3><div class="kanban-list"></div></div>
  </div>
</section>

<!-- Dashboard KPI -->
<section id="seccionDashboard" style="display: none;">
  <h2>Gr√°ficos Mensual</h2>
  <div class="dashboard-filtros" style="margin-bottom:1rem; display:flex; align-items:center; gap:1rem;">
    <div style="display:flex; align-items:center; gap:0.5rem; background:#f8f9fa; border-radius:8px; padding:8px 16px; box-shadow:0 1px 4px #0001;">
      <label for="dashboardFiltroMes" style="font-weight:500; margin:0;">Filtrar por mes:</label>
      <input id="dashboardFiltroMes" type="month" style="padding:4px 10px; border:1px solid #bdbdbd; border-radius:4px; font-size:1rem; background:#fff;">
      <label style="display:flex; align-items:center; gap:0.3rem; margin:0 0 0 10px; font-size:1rem;">
        <input type="checkbox" id="dashboardVerTotal" style="accent-color:#0077b6; width:18px; height:18px;"> Ver total
      </label>
    </div>
  </div>
  <div class="kpi-resumen">
    Total OT: <span id="totalOt"></span> |
    Abiertas: <span id="openOt"></span> |
    En progreso: <span id="progressOt"></span> |
    Cerradas: <span id="closedOt"></span> |
    Retrasadas: <span id="lateOt"></span>
  </div>
  <!-- Gr√°ficos Operativos -->
<h3>Visualizaci√≥n avanzada</h3>
<div class="chart-flex">
  <div class="chart-container"><canvas id="chartEstado"></canvas></div>
  <div class="chart-container"><canvas id="chartArea"></canvas></div>
  <div class="chart-container wide"><canvas id="chartLinea"></canvas></div>
</div>

<h3>An√°lisis por tipo, prioridad, tiempo y categor√≠a</h3> <!-- üîÑ T√≠tulo actualizado -->
<div class="chart-flex">
  <div class="chart-container"><canvas id="chartTipoOT"></canvas></div>
  <div class="chart-container"><canvas id="chartPrioridad"></canvas></div>
 
  <div class="chart-container"><canvas id="chartCategoriaFalla"></canvas></div> <!-- ‚úÖ NUEVA GR√ÅFICA -->
</div>

</section>

<!-- Calendario -->
<section id="seccionCalendario" style="display:none;">
  <h2>Calendario de Mantenimiento</h2>
  <div id="calendar"></div>
</section>

<!-- Configuraci√≥n de Cat√°logos -->
<section id="seccionConfiguracion" style="display:none;">
  <h2>‚öôÔ∏è Configuraci√≥n de Cat√°logos</h2>
  <div class="config-tabs">
    <button id="tabAreas">√Åreas</button>
    <button id="tabEquipos">Equipos</button>
    <button id="tabUsuarios">Usuarios</button>
  </div>
  <div id="configContent">


        <!-- ‚Äî‚Äî‚Äî √Åreas ‚Äî‚Äî‚Äî -->
<div id="sectionAreas" class="config-section">
  <h3>Gesti√≥n de √Åreas</h3>
  <!-- Formulario para Agregar/Editar √Årea -->
  <form id="formArea" class="config-form">
    <label for="areaName">Nombre de √Årea:</label>
    <input type="text" id="areaName" name="areaName" required>
    <button type="submit" id="btnSaveArea">Guardar √Årea</button>
    <button type="button" id="btnCancelArea" class="hidden">Cancelar edici√≥n</button>
  </form>

  <!-- Tabla de √Åreas existentes -->
  <table id="tableAreas" class="config-table">
    <thead>
      <tr>
        <th>Nombre de √Årea</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- ‚Äî‚Äî‚Äî Equipos ‚Äî‚Äî‚Äî -->
<div id="sectionEquipos" class="config-section hidden">
  <h3>Gesti√≥n de Equipos</h3>

  <!-- Formulario para Agregar/Editar Equipo -->
  <form id="formEquipo" class="config-form">
    <label for="equipoName">Nombre de Equipo:</label>
    <input type="text" id="equipoName" name="equipoName" required>

    <label for="equipoArea">√Årea:</label>
    <select id="equipoArea" name="equipoArea" required>
      <!-- Se llena din√°micamente -->
    </select>

    <button type="submit" id="btnSaveEquipo">Guardar Equipo</button>
    <button type="button" id="btnCancelEquipo" class="hidden">Cancelar edici√≥n</button>
  </form>

  <!-- Tabla de Equipos existentes -->
  <table id="tableEquipos" class="config-table">
    <thead>
      <tr>
        <th>Equipo</th>
        <th>√Årea</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- ‚Äî‚Äî‚Äî Usuarios ‚Äî‚Äî‚Äî -->
<div id="sectionUsuarios" class="config-section hidden">
  <h3>Gesti√≥n de Usuarios</h3>

  <!-- Formulario para Agregar/Editar Usuario -->
  <form id="formUsuario" class="config-form">
    <div class="config-form-group">
      <label for="usuarioName">Nombre de Usuario:</label>
      <input type="text" id="usuarioName" name="usuarioName" required>
    </div>
    <div id="divUsuarioEmail" class="config-form-group hidden">
      <label for="usuarioEmail">Correo electr√≥nico (T√©cnico):</label>
      <input type="email" id="usuarioEmail" name="usuarioEmail" placeholder="correo@ejemplo.com">
    </div>

    <div class="config-form-group">
      <label for="usuarioRole">Rol:</label>
      <select id="usuarioRole" name="usuarioRole" required>
        <option value="">Seleccione rol</option>
        <option value="tecnico">T√©cnico</option>
        <option value="operador">Operador</option>
        <option value="supervisor">Supervisor</option>
        <option value="inspector">Inspector de calidad</option>
      </select>
    </div>

    <div id="areaSelectorUsuario" class="config-form-group hidden">
      <label for="usuarioArea">√Årea (solo Operador):</label>
      <select id="usuarioArea" name="usuarioArea">
        <!-- Opciones din√°micas -->
      </select>
    </div>

    <button type="submit" id="btnSaveUsuario">Guardar Usuario</button>
    <button type="button" id="btnCancelUsuario" class="hidden">Cancelar edici√≥n</button>
  </form>

  <!-- Tabla de Usuarios existentes -->
  <table id="tableUsuarios" class="config-table">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Rol</th>
        <th>Correo</th>
        <th>√Årea</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


  </div>
</section>
<!-- ‚Äî‚Äî‚Äî Modal Editar Multidisciplinaria ‚Äî‚Äî‚Äî -->
<div id="editMdModal" class="modal hidden">
  <div class="modal-content" style="max-width:600px; max-height:90vh; overflow:auto;">
    <span id="closeEditMdModal" class="close">&times;</span>
    <h3>Editar Multidisciplinaria</h3>

    <div class="ot-grid" style="margin-top:1rem;">
      <div class="ot-group">
        <label for="editMdFechaFinal">Fecha Final</label>
        <input type="date" id="editMdFechaFinal" required>
      </div>
      <div class="ot-group">
        <label for="editMdSelectTecnico">T√©cnico</label>
        <select id="editMdSelectTecnico" required>
          <option value="">Seleccione T√©cnico</option>
        </select>
      </div>
      <div class="ot-group">
        <label for="editMdSelectEstado">Estado</label>
        <select id="editMdSelectEstado" required>
          <option value="Abierta">Abierta</option>
          <option value="En Proceso">En Proceso</option>
          <option value="Cerrada">Cerrada</option>
        </select>
      </div>
    </div>

    <div class="form-section" style="margin-top:1rem; padding:1rem;">
      <h4>Fotos Antes (m√°x 2)</h4>
      <div class="ot-group">
        <input type="file" id="editMdFotosAntes" accept="image/*" multiple>
        <div id="editMdPreviewAntes" class="image-preview"></div>
      </div>
      <h4>Fotos Despu√©s (m√°x 2)</h4>
      <div class="ot-group">
        <input type="file" id="editMdFotosDespues" accept="image/*" multiple>
        <div id="editMdPreviewDespues" class="image-preview"></div>
      </div>
    </div>

    <div style="text-align:right; margin-top:1rem;">
      <button id="btnSaveEditMd" class="ot-submit">üíæ Guardar Cambios</button>
      <button id="btnCancelEditMd" class="ot-submit" style="background:#e63946;">‚úñ Cancelar</button>
    </div>
  </div>
</div>
<!-- ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî -->

<!-- ‚Äî‚Äî‚Äî Modal Nueva Multidisciplinaria ‚Äî‚Äî‚Äî -->
<div id="mdModal" class="modal hidden">
  <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow: auto;">

    <span id="closeMdModal" class="close">&times;</span>
    <h3>Registrar Multidisciplinaria</h3>

    <!-- Campos persistentes -->
    <div class="ot-grid" style="margin-top: 1rem;">
      <div class="ot-group">
        <label for="mdFechaInicio">Fecha</label>
        <input type="date" id="mdFechaInicio" required>
      </div>
      <div class="ot-group">
        <label for="mdSelectArea">√Årea</label>
        <select id="mdSelectArea" required>
          <option value="">Seleccione √Årea</option>
        </select>
      </div>
      <div class="ot-group">
        <label for="mdSelectEstado">Estado</label>
        <select id="mdSelectEstado" required>
          <option value="">Seleccione Estado</option>
          <option value="Abierta">Abierta</option>
          <option value="En Proceso">En Proceso</option>
          <option value="Cerrada">Cerrada</option>
        </select>
        <!-- ‚Üê Aqu√≠ inserta este bloque justo debajo de Estado -->
      <div class="ot-group">
        <label for="mdSelectPrioridad" style="margin-top:12px;display:block;">Prioridad</label>
        <select id="mdSelectPrioridad" required style="margin-top:4px;">
          <option value="">Seleccione Prioridad</option>
          <option value="Alta">Alta</option>
          <option value="Media">Media</option>
          <option value="Baja">Baja</option>
        </select>
      </div>
      </div>
    </div>

    <!-- Campos epis√≥dicos -->
    <div class="form-section" style="margin-top: 1rem; padding: 1rem;">
      <h4>Descripci√≥n y Fotos</h4>
      <div class="ot-grid">
        <div class="ot-group ot-wide">
          <label for="mdDescripcion">Descripci√≥n</label>
          <textarea id="mdDescripcion" rows="3"></textarea>
        </div>
        <div class="ot-group">
          <label for="mdFotos">Fotos (m√°x 2)</label>
          <input type="file" id="mdFotos" accept="image/*" multiple>
          <div id="mdPreviewFotos" class="image-preview"></div>
        </div>
      </div>
    </div>

    <!-- Botones -->
    <div style="text-align: right; margin-top: 1rem;">
      <button id="btnAddMD" class="ot-submit">‚ûï Agregar</button>
      <button id="btnCloseMD" class="ot-submit" style="background: #e63946;">‚úñ Cerrar</button>
    </div>
  </div>
</div>
<!-- ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî -->


<!-- Modal de Imagen en Tama√±o Real -->
<div id="imageModal" class="modal hidden">
  <div class="modal-content">
    <span id="closeImageModal" class="close">&times;</span>
    <img id="modalImage" src="" alt="Imagen completa"
         style="max-width: 90vw; max-height: 90vh; object-fit: contain;">
  </div>
</div>

<!-- Modal QR -->
<div id="qrModal" class="modal hidden">
  <div class="modal-content">
    <span id="closeQr" class="close">&times;</span>
    <h3>QR del Equipo</h3>
    <canvas id="qrCanvas"></canvas>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden"></div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>


<script>
  const database = firebase.database();

  document.getElementById("formFalla").addEventListener("submit", function(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(this).entries());

    // Guardar en tabla HTML
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${data.fecha}</td>
      <td>${data.area}</td>
      <td>${data.equipo}</td>
      <td>${data.falla}</td>
      <td>${data.horaInicio}</td>
      <td>${data.horaFin}</td>
      <td>${data.supervisor}</td>
    `;
    document.getElementById("tablaBody").appendChild(row);

   // Convertir IDs en nombres legibles
data.firmaTecnico    = document.querySelector('select[name="firmaTecnico"]').selectedOptions[0].textContent;
data.firmaSupervisor = document.querySelector('select[name="firmaSupervisor"]').selectedOptions[0].textContent;
data.firmaOperador   = document.querySelector('select[name="firmaOperador"]').selectedOptions[0].textContent;
data.area            = document.querySelector('select[name="area"]').selectedOptions[0].textContent;
data.equipo          = document.querySelector('select[name="equipo"]').selectedOptions[0].textContent;

// Guardar en localStorage
const reportes = JSON.parse(localStorage.getItem("reportes") || "[]");
reportes.push(data);
localStorage.setItem("reportes", JSON.stringify(reportes));

// Guardar en Firebase
database.ref("reportesFalla").push(data);


    this.reset();
    document.querySelector('select[name="equipo"]').innerHTML = "";
  });
</script>
<script>
// Al abrir el modal de nueva multidisciplinaria, poner la fecha actual en el campo de fecha
document.addEventListener('DOMContentLoaded', function() {
  const mdModal = document.getElementById('mdModal');
  const mdFechaInicio = document.getElementById('mdFechaInicio');
  const btnNuevoMD = document.getElementById('btnNuevoMD');
  if (mdModal && mdFechaInicio && btnNuevoMD) {
    btnNuevoMD.addEventListener('click', function() {
      // Formato yyyy-mm-dd
      const hoy = new Date();
      const yyyy = hoy.getFullYear();
      const mm = String(hoy.getMonth() + 1).padStart(2, '0');
      const dd = String(hoy.getDate()).padStart(2, '0');
      mdFechaInicio.value = `${yyyy}-${mm}-${dd}`;
    });
  }
});
</script>

<script>
  const inicioInput = document.querySelector('input[name="horaInicioReparacion"]');
  const finInput = document.querySelector('input[name="horaFinReparacion"]');
  const tiempoTotalInput = document.getElementById('tiempototal');

  function calcularMinutos() {
    const inicio = inicioInput.value;
    const fin = finInput.value;

    if (!inicio || !fin) return;

    const [hInicio, mInicio] = inicio.split(':').map(Number);
    const [hFin, mFin] = fin.split(':').map(Number);

    const tInicio = hInicio * 60 + mInicio;
    const tFin = hFin * 60 + mFin;

    let totalMin = tFin - tInicio;
    if (totalMin < 0) totalMin += 1440; // correcci√≥n para paso de medianoche

    tiempoTotalInput.value = totalMin;
  }

  inicioInput.addEventListener('change', calcularMinutos);
  finInput.addEventListener('change', calcularMinutos);
</script>
   <!-- Toggle sidebar en m√≥vil y cierre autom√°tico -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('menuToggle');
      const sb  = document.querySelector('.sidebar');

      // 1) Al tocar ‚ò∞ abre o cierra el sidebar
      btn.addEventListener('click', e => {
        e.stopPropagation();
        sb.classList.toggle('open');
      });

      // 2) Al tocar fuera del sidebar, se cierra
      document.addEventListener('click', e => {
        if (sb.classList.contains('open')
            && !sb.contains(e.target)
            && e.target !== btn) {
          sb.classList.remove('open');
        }
      });

      // 3) Cada vez que tocas un bot√≥n del men√∫, se cierra
      sb.querySelectorAll('button').forEach(b => {
        b.addEventListener('click', () => sb.classList.remove('open'));
      });
    });
  </script>
</script>
<script>
// Miniaturas para campo 'Fotos Antes' en edici√≥n de MD
document.addEventListener('DOMContentLoaded', function() {
  const inputAntes = document.getElementById('editMdFotosAntes');
  const previewAntes = document.getElementById('editMdPreviewAntes');
  if (inputAntes && previewAntes) {
    inputAntes.addEventListener('change', function() {
      previewAntes.innerHTML = '';
      const files = Array.from(inputAntes.files).slice(0,2); // m√°x 2
      files.forEach(file => {
        if (!file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.style.maxWidth = '80px';
          img.style.maxHeight = '80px';
          img.style.margin = '4px';
          img.style.objectFit = 'cover';
          img.alt = 'Miniatura';
          previewAntes.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });
  }
});
</script>
<script defer src="main.js?v=1.1.15"></script>
</body>
</html>
